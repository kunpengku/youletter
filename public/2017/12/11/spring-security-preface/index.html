<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-7674654031652018",
enable_page_level_ads: true
});</script><title> spring security-preface · 由来</title><meta name="description" content="spring security-preface - kunpengku"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.youletter.cn/atom.xml" title="由来"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">由来</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>主页</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>归档</p></a><a href="/about" target="_self" class="li component-nav-item"><p>关于我</p></a><ul class="shortcut-icons"><a href="https://github.com/kunpengku" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">spring security-preface</h1><div class="post-info">2017年12月11日</div><div class="post-content"><p>官方文档</p>
<p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle" target="_blank" rel="external">Spring Security Reference</a></p>
<p><a href="https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project" target="_blank" rel="external">十大漏洞</a></p>
<p>Authentication 是 识别建立一个 Principal ,Principal是一个用户，或者一个人，或者一个设备，就是行为主体， 认证之意，证明你是你。</p>
<p>Authorization 是决定 这个Principal   能有哪些行为。 授权之意，表示你能做什么。</p>
<h2 id="Spring-Security-版本号说明"><a href="#Spring-Security-版本号说明" class="headerlink" title="Spring Security 版本号说明"></a>Spring Security 版本号说明</h2><p>版本号分三级 MAJOR.MINOR.PATCH</p>
<p>MAJOR 的意思是 API有重大修改，不兼容。  如 5.0.0 和 4.2.3 不兼容。</p>
<p>MINOR 的意思是 小的修改 ，可能不兼容。</p>
<p>PATCH 绝对兼容。比如 4.2.3 和 4.2.1</p>
<h2 id="maven-依赖"><a href="#maven-依赖" class="headerlink" title="maven 依赖"></a>maven 依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;</div><div class="line">	&lt;version&gt;5.0.0.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;</div><div class="line">	&lt;version&gt;5.0.0.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>实际的开发中 可能不会 显示的 写这个依赖 ，比如 如果用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-cloud-starter-security&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>就会包含这个依赖。</p>
<h2 id="开启debug日志"><a href="#开启debug日志" class="headerlink" title="开启debug日志"></a>开启debug日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 开启spring security的 debug日志</div><div class="line">logging:</div><div class="line">  level:</div><div class="line">    org:</div><div class="line">      springframework:</div><div class="line">        security: DEBUG</div></pre></td></tr></table></figure>
<h2 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h2><p>This is where we store details of the present security context</p>
<h2 id="Authentication中存储-个人信息。"><a href="#Authentication中存储-个人信息。" class="headerlink" title="Authentication中存储 个人信息。"></a>Authentication中存储 个人信息。</h2><p>Authentication中存储 个人信息<br>在程序中的任何地方，可以用下面这段代码 来获取 已 认证的 用户信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</div><div class="line"></div><div class="line">if (principal instanceof UserDetails) &#123;</div><div class="line">String username = ((UserDetails)principal).getUsername();</div><div class="line">&#125; else &#123;</div><div class="line">String username = principal.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="UserDetails"><a href="#UserDetails" class="headerlink" title="UserDetails"></a>UserDetails</h2><p>Authentication 中可以取到 Principal ，这是一个Object ，在Spring Security中Principal 大部分情况都是 UserDetails。</p>
<p>UserDetails是一个核心接口，它是 SecurityContextHolder 和 你的数据库中 真是用户信息的 一种联系。</p>
<h2 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h2><p>获取UserDetails的方法是  实现UserDetailsService 接口， 这个接口 只有一个方法， 就是通过 String name 获取 UserDetails。</p>
<p>对于UserDetailsService的实现，官方有一个基于数据库的实现 JdbcDaoImpl ，很有参考的地方。</p>
<a id="more"></a>
<p>JdbcDaoImpl.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Copyright 2004, 2005, 2006 Acegi Technology Pty Limited</div><div class="line"> *</div><div class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div class="line"> * you may not use this file except in compliance with the License.</div><div class="line"> * You may obtain a copy of the License at</div><div class="line"> *</div><div class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</div><div class="line"> *</div><div class="line"> * Unless required by applicable law or agreed to in writing, software</div><div class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div class="line"> * See the License for the specific language governing permissions and</div><div class="line"> * limitations under the License.</div><div class="line"> */</div><div class="line"></div><div class="line">package org.springframework.security.core.userdetails.jdbc;</div><div class="line"></div><div class="line">import java.sql.ResultSet;</div><div class="line">import java.sql.SQLException;</div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.HashSet;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">import org.springframework.context.ApplicationContextException;</div><div class="line">import org.springframework.context.MessageSource;</div><div class="line">import org.springframework.context.MessageSourceAware;</div><div class="line">import org.springframework.context.support.MessageSourceAccessor;</div><div class="line">import org.springframework.jdbc.core.RowMapper;</div><div class="line">import org.springframework.jdbc.core.support.JdbcDaoSupport;</div><div class="line">import org.springframework.security.core.GrantedAuthority;</div><div class="line">import org.springframework.security.core.SpringSecurityMessageSource;</div><div class="line">import org.springframework.security.core.authority.AuthorityUtils;</div><div class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</div><div class="line">import org.springframework.security.core.userdetails.User;</div><div class="line">import org.springframework.security.core.userdetails.UserDetails;</div><div class="line">import org.springframework.security.core.userdetails.UserDetailsService;</div><div class="line">import org.springframework.security.core.userdetails.UsernameNotFoundException;</div><div class="line">import org.springframework.util.Assert;</div><div class="line"></div><div class="line">/**</div><div class="line"> * &lt;tt&gt;UserDetailsServiceRetrieves&lt;/tt&gt; implementation which retrieves the user details</div><div class="line"> * (username, password, enabled flag, and authorities) from a database using JDBC queries.</div><div class="line"> *</div><div class="line"> * &lt;h3&gt;Default Schema&lt;/h3&gt; A default database schema is assumed, with two tables &quot;users&quot;</div><div class="line"> * and &quot;authorities&quot;.</div><div class="line"> *</div><div class="line"> * &lt;h4&gt;The Users table&lt;/h4&gt;</div><div class="line"> *</div><div class="line"> * This table contains the login name, password and enabled status of the user.</div><div class="line"> *</div><div class="line"> * &lt;table summary=&quot;The Users Table&quot;&gt;</div><div class="line"> * &lt;tr&gt;</div><div class="line"> * &lt;th&gt;Column&lt;/th&gt;</div><div class="line"> * &lt;/tr&gt;</div><div class="line"> * &lt;tr&gt;</div><div class="line"> * &lt;td&gt;username&lt;/td&gt;</div><div class="line"> * &lt;/tr&gt;</div><div class="line"> * &lt;tr&gt;</div><div class="line"> * &lt;td&gt;password&lt;/td&gt;</div><div class="line"> * &lt;/tr&gt;</div><div class="line"> * &lt;tr&gt;</div><div class="line"> * &lt;td&gt;enabled&lt;/td&gt;</div><div class="line"> * &lt;/tr&gt;</div><div class="line"> * &lt;/table&gt;</div><div class="line"> *</div><div class="line"> * &lt;h4&gt;The Authorities Table&lt;/h4&gt;</div><div class="line"> *</div><div class="line"> * &lt;table summary=&quot;The Authorities Table&quot;&gt;</div><div class="line"> * &lt;tr&gt;</div><div class="line"> * &lt;th&gt;Column&lt;/th&gt;</div><div class="line"> * &lt;/tr&gt;</div><div class="line"> * &lt;tr&gt;</div><div class="line"> * &lt;td&gt;username&lt;/td&gt;</div><div class="line"> * &lt;/tr&gt;</div><div class="line"> * &lt;tr&gt;</div><div class="line"> * &lt;td&gt;authority&lt;/td&gt;</div><div class="line"> * &lt;/tr&gt;</div><div class="line"> * &lt;/table&gt;</div><div class="line"> *</div><div class="line"> * If you are using an existing schema you will have to set the queries</div><div class="line"> * &lt;tt&gt;usersByUsernameQuery&lt;/tt&gt; and &lt;tt&gt;authoritiesByUsernameQuery&lt;/tt&gt; to match your</div><div class="line"> * database setup (see &#123;@link #DEF_USERS_BY_USERNAME_QUERY&#125; and</div><div class="line"> * &#123;@link #DEF_AUTHORITIES_BY_USERNAME_QUERY&#125;).</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * In order to minimise backward compatibility issues, this implementation doesn&apos;t</div><div class="line"> * recognise the expiration of user accounts or the expiration of user credentials.</div><div class="line"> * However, it does recognise and honour the user enabled/disabled column. This should map</div><div class="line"> * to a &lt;tt&gt;boolean&lt;/tt&gt; type in the result set (the SQL type will depend on the database</div><div class="line"> * you are using). All the other columns map to &lt;tt&gt;String&lt;/tt&gt;s.</div><div class="line"> *</div><div class="line"> * &lt;h3&gt;Group Support&lt;/h3&gt; Support for group-based authorities can be enabled by setting</div><div class="line"> * the &lt;tt&gt;enableGroups&lt;/tt&gt; property to &lt;tt&gt;true&lt;/tt&gt; (you may also then wish to set</div><div class="line"> * &lt;tt&gt;enableAuthorities&lt;/tt&gt; to &lt;tt&gt;false&lt;/tt&gt; to disable loading of authorities</div><div class="line"> * directly). With this approach, authorities are allocated to groups and a user&apos;s</div><div class="line"> * authorities are determined based on the groups they are a member of. The net result is</div><div class="line"> * the same (a UserDetails containing a set of &lt;tt&gt;GrantedAuthority&lt;/tt&gt;s is loaded), but</div><div class="line"> * the different persistence strategy may be more suitable for the administration of some</div><div class="line"> * applications.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * When groups are being used, the tables &quot;groups&quot;, &quot;group_members&quot; and</div><div class="line"> * &quot;group_authorities&quot; are used. See &#123;@link #DEF_GROUP_AUTHORITIES_BY_USERNAME_QUERY&#125; for</div><div class="line"> * the default query which is used to load the group authorities. Again you can customize</div><div class="line"> * this by setting the &lt;tt&gt;groupAuthoritiesByUsernameQuery&lt;/tt&gt; property, but the format</div><div class="line"> * of the rows returned should match the default.</div><div class="line"> *</div><div class="line"> * @author Ben Alex</div><div class="line"> * @author colin sampaleanu</div><div class="line"> * @author Luke Taylor</div><div class="line"> */</div><div class="line">public class JdbcDaoImpl extends JdbcDaoSupport</div><div class="line">		implements UserDetailsService, MessageSourceAware &#123;</div><div class="line">	// ~ Static fields/initializers</div><div class="line">	// =====================================================================================</div><div class="line"></div><div class="line">	public static final String DEF_USERS_BY_USERNAME_QUERY = &quot;select username,password,enabled &quot;</div><div class="line">			+ &quot;from users &quot; + &quot;where username = ?&quot;;</div><div class="line">	public static final String DEF_AUTHORITIES_BY_USERNAME_QUERY = &quot;select username,authority &quot;</div><div class="line">			+ &quot;from authorities &quot; + &quot;where username = ?&quot;;</div><div class="line">	public static final String DEF_GROUP_AUTHORITIES_BY_USERNAME_QUERY = &quot;select g.id, g.group_name, ga.authority &quot;</div><div class="line">			+ &quot;from groups g, group_members gm, group_authorities ga &quot;</div><div class="line">			+ &quot;where gm.username = ? &quot; + &quot;and g.id = ga.group_id &quot;</div><div class="line">			+ &quot;and g.id = gm.group_id&quot;;</div><div class="line"></div><div class="line">	// ~ Instance fields</div><div class="line">	// ================================================================================================</div><div class="line"></div><div class="line">	protected MessageSourceAccessor messages = SpringSecurityMessageSource.getAccessor();</div><div class="line"></div><div class="line">	private String authoritiesByUsernameQuery;</div><div class="line">	private String groupAuthoritiesByUsernameQuery;</div><div class="line">	private String usersByUsernameQuery;</div><div class="line">	private String rolePrefix = &quot;&quot;;</div><div class="line">	private boolean usernameBasedPrimaryKey = true;</div><div class="line">	private boolean enableAuthorities = true;</div><div class="line">	private boolean enableGroups;</div><div class="line"></div><div class="line">	// ~ Constructors</div><div class="line">	// ===================================================================================================</div><div class="line"></div><div class="line">	public JdbcDaoImpl() &#123;</div><div class="line">		this.usersByUsernameQuery = DEF_USERS_BY_USERNAME_QUERY;</div><div class="line">		this.authoritiesByUsernameQuery = DEF_AUTHORITIES_BY_USERNAME_QUERY;</div><div class="line">		this.groupAuthoritiesByUsernameQuery = DEF_GROUP_AUTHORITIES_BY_USERNAME_QUERY;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// ~ Methods</div><div class="line">	// ========================================================================================================</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * @return the messages</div><div class="line">	 */</div><div class="line">	protected MessageSourceAccessor getMessages() &#123;</div><div class="line">		return this.messages;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Allows subclasses to add their own granted authorities to the list to be returned</div><div class="line">	 * in the &lt;tt&gt;UserDetails&lt;/tt&gt;.</div><div class="line">	 *</div><div class="line">	 * @param username the username, for use by finder methods</div><div class="line">	 * @param authorities the current granted authorities, as populated from the</div><div class="line">	 * &lt;code&gt;authoritiesByUsername&lt;/code&gt; mapping</div><div class="line">	 */</div><div class="line">	protected void addCustomAuthorities(String username,</div><div class="line">			List&lt;GrantedAuthority&gt; authorities) &#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String getUsersByUsernameQuery() &#123;</div><div class="line">		return this.usersByUsernameQuery;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	protected void initDao() throws ApplicationContextException &#123;</div><div class="line">		Assert.isTrue(this.enableAuthorities || this.enableGroups,</div><div class="line">				&quot;Use of either authorities or groups must be enabled&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public UserDetails loadUserByUsername(String username)</div><div class="line">			throws UsernameNotFoundException &#123;</div><div class="line">		List&lt;UserDetails&gt; users = loadUsersByUsername(username);</div><div class="line"></div><div class="line">		if (users.size() == 0) &#123;</div><div class="line">			this.logger.debug(&quot;Query returned no results for user &apos;&quot; + username + &quot;&apos;&quot;);</div><div class="line"></div><div class="line">			throw new UsernameNotFoundException(</div><div class="line">					this.messages.getMessage(&quot;JdbcDaoImpl.notFound&quot;,</div><div class="line">							new Object[] &#123; username &#125;, &quot;Username &#123;0&#125; not found&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		UserDetails user = users.get(0); // contains no GrantedAuthority[]</div><div class="line"></div><div class="line">		Set&lt;GrantedAuthority&gt; dbAuthsSet = new HashSet&lt;GrantedAuthority&gt;();</div><div class="line"></div><div class="line">		if (this.enableAuthorities) &#123;</div><div class="line">			dbAuthsSet.addAll(loadUserAuthorities(user.getUsername()));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (this.enableGroups) &#123;</div><div class="line">			dbAuthsSet.addAll(loadGroupAuthorities(user.getUsername()));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		List&lt;GrantedAuthority&gt; dbAuths = new ArrayList&lt;GrantedAuthority&gt;(dbAuthsSet);</div><div class="line"></div><div class="line">		addCustomAuthorities(user.getUsername(), dbAuths);</div><div class="line"></div><div class="line">		if (dbAuths.size() == 0) &#123;</div><div class="line">			this.logger.debug(&quot;User &apos;&quot; + username</div><div class="line">					+ &quot;&apos; has no authorities and will be treated as &apos;not found&apos;&quot;);</div><div class="line"></div><div class="line">			throw new UsernameNotFoundException(this.messages.getMessage(</div><div class="line">					&quot;JdbcDaoImpl.noAuthority&quot;, new Object[] &#123; username &#125;,</div><div class="line">					&quot;User &#123;0&#125; has no GrantedAuthority&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		return createUserDetails(username, user, dbAuths);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Executes the SQL &lt;tt&gt;usersByUsernameQuery&lt;/tt&gt; and returns a list of UserDetails</div><div class="line">	 * objects. There should normally only be one matching user.</div><div class="line">	 */</div><div class="line">	protected List&lt;UserDetails&gt; loadUsersByUsername(String username) &#123;</div><div class="line">		return getJdbcTemplate().query(this.usersByUsernameQuery,</div><div class="line">				new String[] &#123; username &#125;, new RowMapper&lt;UserDetails&gt;() &#123;</div><div class="line">					@Override</div><div class="line">					public UserDetails mapRow(ResultSet rs, int rowNum)</div><div class="line">							throws SQLException &#123;</div><div class="line">						String username = rs.getString(1);</div><div class="line">						String password = rs.getString(2);</div><div class="line">						boolean enabled = rs.getBoolean(3);</div><div class="line">						return new User(username, password, enabled, true, true, true,</div><div class="line">								AuthorityUtils.NO_AUTHORITIES);</div><div class="line">					&#125;</div><div class="line"></div><div class="line">				&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Loads authorities by executing the SQL from &lt;tt&gt;authoritiesByUsernameQuery&lt;/tt&gt;.</div><div class="line">	 *</div><div class="line">	 * @return a list of GrantedAuthority objects for the user</div><div class="line">	 */</div><div class="line">	protected List&lt;GrantedAuthority&gt; loadUserAuthorities(String username) &#123;</div><div class="line">		return getJdbcTemplate().query(this.authoritiesByUsernameQuery,</div><div class="line">				new String[] &#123; username &#125;, new RowMapper&lt;GrantedAuthority&gt;() &#123;</div><div class="line">					@Override</div><div class="line">					public GrantedAuthority mapRow(ResultSet rs, int rowNum)</div><div class="line">							throws SQLException &#123;</div><div class="line">						String roleName = JdbcDaoImpl.this.rolePrefix + rs.getString(2);</div><div class="line"></div><div class="line">						return new SimpleGrantedAuthority(roleName);</div><div class="line">					&#125;</div><div class="line">				&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Loads authorities by executing the SQL from</div><div class="line">	 * &lt;tt&gt;groupAuthoritiesByUsernameQuery&lt;/tt&gt;.</div><div class="line">	 *</div><div class="line">	 * @return a list of GrantedAuthority objects for the user</div><div class="line">	 */</div><div class="line">	protected List&lt;GrantedAuthority&gt; loadGroupAuthorities(String username) &#123;</div><div class="line">		return getJdbcTemplate().query(this.groupAuthoritiesByUsernameQuery,</div><div class="line">				new String[] &#123; username &#125;, new RowMapper&lt;GrantedAuthority&gt;() &#123;</div><div class="line">					@Override</div><div class="line">					public GrantedAuthority mapRow(ResultSet rs, int rowNum)</div><div class="line">							throws SQLException &#123;</div><div class="line">						String roleName = getRolePrefix() + rs.getString(3);</div><div class="line"></div><div class="line">						return new SimpleGrantedAuthority(roleName);</div><div class="line">					&#125;</div><div class="line">				&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Can be overridden to customize the creation of the final UserDetailsObject which is</div><div class="line">	 * returned by the &lt;tt&gt;loadUserByUsername&lt;/tt&gt; method.</div><div class="line">	 *</div><div class="line">	 * @param username the name originally passed to loadUserByUsername</div><div class="line">	 * @param userFromUserQuery the object returned from the execution of the</div><div class="line">	 * @param combinedAuthorities the combined array of authorities from all the authority</div><div class="line">	 * loading queries.</div><div class="line">	 * @return the final UserDetails which should be used in the system.</div><div class="line">	 */</div><div class="line">	protected UserDetails createUserDetails(String username,</div><div class="line">			UserDetails userFromUserQuery, List&lt;GrantedAuthority&gt; combinedAuthorities) &#123;</div><div class="line">		String returnUsername = userFromUserQuery.getUsername();</div><div class="line"></div><div class="line">		if (!this.usernameBasedPrimaryKey) &#123;</div><div class="line">			returnUsername = username;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		return new User(returnUsername, userFromUserQuery.getPassword(),</div><div class="line">				userFromUserQuery.isEnabled(), true, true, true, combinedAuthorities);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Allows the default query string used to retrieve authorities based on username to</div><div class="line">	 * be overridden, if default table or column names need to be changed. The default</div><div class="line">	 * query is &#123;@link #DEF_AUTHORITIES_BY_USERNAME_QUERY&#125;; when modifying this query,</div><div class="line">	 * ensure that all returned columns are mapped back to the same column names as in the</div><div class="line">	 * default query.</div><div class="line">	 *</div><div class="line">	 * @param queryString The SQL query string to set</div><div class="line">	 */</div><div class="line">	public void setAuthoritiesByUsernameQuery(String queryString) &#123;</div><div class="line">		this.authoritiesByUsernameQuery = queryString;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	protected String getAuthoritiesByUsernameQuery() &#123;</div><div class="line">		return this.authoritiesByUsernameQuery;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Allows the default query string used to retrieve group authorities based on</div><div class="line">	 * username to be overridden, if default table or column names need to be changed. The</div><div class="line">	 * default query is &#123;@link #DEF_GROUP_AUTHORITIES_BY_USERNAME_QUERY&#125;; when modifying</div><div class="line">	 * this query, ensure that all returned columns are mapped back to the same column</div><div class="line">	 * names as in the default query.</div><div class="line">	 *</div><div class="line">	 * @param queryString The SQL query string to set</div><div class="line">	 */</div><div class="line">	public void setGroupAuthoritiesByUsernameQuery(String queryString) &#123;</div><div class="line">		this.groupAuthoritiesByUsernameQuery = queryString;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Allows a default role prefix to be specified. If this is set to a non-empty value,</div><div class="line">	 * then it is automatically prepended to any roles read in from the db. This may for</div><div class="line">	 * example be used to add the &lt;tt&gt;ROLE_&lt;/tt&gt; prefix expected to exist in role names</div><div class="line">	 * (by default) by some other Spring Security classes, in the case that the prefix is</div><div class="line">	 * not already present in the db.</div><div class="line">	 *</div><div class="line">	 * @param rolePrefix the new prefix</div><div class="line">	 */</div><div class="line">	public void setRolePrefix(String rolePrefix) &#123;</div><div class="line">		this.rolePrefix = rolePrefix;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	protected String getRolePrefix() &#123;</div><div class="line">		return this.rolePrefix;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * If &lt;code&gt;true&lt;/code&gt; (the default), indicates the</div><div class="line">	 * &#123;@link #getUsersByUsernameQuery()&#125; returns a username in response to a query. If</div><div class="line">	 * &lt;code&gt;false&lt;/code&gt;, indicates that a primary key is used instead. If set to</div><div class="line">	 * &lt;code&gt;true&lt;/code&gt;, the class will use the database-derived username in the returned</div><div class="line">	 * &lt;code&gt;UserDetails&lt;/code&gt;. If &lt;code&gt;false&lt;/code&gt;, the class will use the</div><div class="line">	 * &#123;@link #loadUserByUsername(String)&#125; derived username in the returned</div><div class="line">	 * &lt;code&gt;UserDetails&lt;/code&gt;.</div><div class="line">	 *</div><div class="line">	 * @param usernameBasedPrimaryKey &lt;code&gt;true&lt;/code&gt; if the mapping queries return the</div><div class="line">	 * username &lt;code&gt;String&lt;/code&gt;, or &lt;code&gt;false&lt;/code&gt; if the mapping returns a</div><div class="line">	 * database primary key.</div><div class="line">	 */</div><div class="line">	public void setUsernameBasedPrimaryKey(boolean usernameBasedPrimaryKey) &#123;</div><div class="line">		this.usernameBasedPrimaryKey = usernameBasedPrimaryKey;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	protected boolean isUsernameBasedPrimaryKey() &#123;</div><div class="line">		return this.usernameBasedPrimaryKey;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Allows the default query string used to retrieve users based on username to be</div><div class="line">	 * overridden, if default table or column names need to be changed. The default query</div><div class="line">	 * is &#123;@link #DEF_USERS_BY_USERNAME_QUERY&#125;; when modifying this query, ensure that all</div><div class="line">	 * returned columns are mapped back to the same column names as in the default query.</div><div class="line">	 * If the &apos;enabled&apos; column does not exist in the source database, a permanent true</div><div class="line">	 * value for this column may be returned by using a query similar to</div><div class="line">	 *</div><div class="line">	 * &lt;pre&gt;</div><div class="line">	 * &amp;quot;select username,password,&apos;true&apos; as enabled from users where username = ?&amp;quot;</div><div class="line">	 * &lt;/pre&gt;</div><div class="line">	 *</div><div class="line">	 * @param usersByUsernameQueryString The query string to set</div><div class="line">	 */</div><div class="line">	public void setUsersByUsernameQuery(String usersByUsernameQueryString) &#123;</div><div class="line">		this.usersByUsernameQuery = usersByUsernameQueryString;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	protected boolean getEnableAuthorities() &#123;</div><div class="line">		return this.enableAuthorities;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Enables loading of authorities (roles) from the authorities table. Defaults to true</div><div class="line">	 */</div><div class="line">	public void setEnableAuthorities(boolean enableAuthorities) &#123;</div><div class="line">		this.enableAuthorities = enableAuthorities;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	protected boolean getEnableGroups() &#123;</div><div class="line">		return this.enableGroups;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Enables support for group authorities. Defaults to false</div><div class="line">	 * @param enableGroups</div><div class="line">	 */</div><div class="line">	public void setEnableGroups(boolean enableGroups) &#123;</div><div class="line">		this.enableGroups = enableGroups;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public void setMessageSource(MessageSource messageSource) &#123;</div><div class="line">		Assert.notNull(messageSource, &quot;messageSource cannot be null&quot;);</div><div class="line">		this.messages = new MessageSourceAccessor(messageSource);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="GrantedAuthority"><a href="#GrantedAuthority" class="headerlink" title="GrantedAuthority"></a>GrantedAuthority</h2><p>Authentication的另一个重要方法是 getAuthorities()，获取 该用户有哪些 权限。</p>
<h2 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h2><p>AuthenticationManager 也是一个接口, 就是 验证 登录的用户 是否 合法，如何合法，则返回一个 authentication， 不合法直接 抛错。</p>
<h2 id="ProviderManager"><a href="#ProviderManager" class="headerlink" title="ProviderManager"></a>ProviderManager</h2><p>ProviderManager是 实现AuthenticationManager接口的类。表面上是这样。<br>实际上，ProviderManager 将这个认证的 工作 委托给 一列 AuthenticationProvider。 又AuthenticationProvider 来 验证用户。</p>
<h2 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h2><p>AuthenticationProvider也是接口。 如何验证用户呢？ 还记得上面的UserDetails吗？</p>
<h2 id="DaoAuthenticationProvider"><a href="#DaoAuthenticationProvider" class="headerlink" title="DaoAuthenticationProvider"></a>DaoAuthenticationProvider</h2><p>DaoAuthenticationProvider实现了AuthenticationProvider接口，通常 ，使用 DaoAuthenticationProvider 来实现验证用户的。 因为用户名密码 通常存在数据库中。</p>
<p>使用DaoAuthenticationProvider需要两个信息，</p>
<ul>
<li>userDetailsService</li>
<li>passwordEncoder   加密方式</li>
</ul>
<p><a href="https://docs.spring.io/spring-security/site/docs/4.2.3.RELEASE/reference/htmlsingle/#core-services-dao-provider" target="_blank" rel="external">DaoAuthenticationProvider</a></p>
<h2 id="UserDetailsService实现"><a href="#UserDetailsService实现" class="headerlink" title="UserDetailsService实现"></a>UserDetailsService实现</h2><p>有一种 In-Memory 内存中存储 用户信息的方法 ，但这种 只可以调试 ，是无法在 生产中使用的。</p>
<p>实际中使用的 ，用户名 和 密码一般是在 数据库中存储的。<br>上面已经贴了一个 JdbcDaoImpl.java 的实现 。</p>
<p>这里了使用的是原生的 dataSource 。 但如果 代码中使用了 如 Mybatis这样的 dao ，只需要小小改动一下 ，自己实现一下 loadUserByUsername 这个方法即可。</p>
<p>实现loadUserByUsername 的过程 ，也即是 实现 UserDetails的过程。</p>
<p>实现UserDetails的 Domain 一般是 存在 数据库中的 记录对应的 pojo。</p>
<h2 id="Password-Encoding"><a href="#Password-Encoding" class="headerlink" title="Password Encoding"></a>Password Encoding</h2><p>推荐使用 BCryptPasswordEncoder 来作为 加密器。<br>BCryptPasswordEncoder的特点就 加密特别慢， 这样 破解起来就很慢了 。</p>
</div></article></div><div id="disqus_thread"></div></div><div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;"><img src="/images/WechatIMG5.jpeg" width="180px"><p>简单点，讨钱的方式简单点</p><button style="display: inline-block;      width: 80px;      height: 35px;      border-radius: 5px;      color: #fff;      font-weight: 400;      font-style: normal;      font-variant: normal;      font-stretch: normal;      font-size: 18px;      background: #f44336;"><span>赏</span></button></div><div id="ads"></div><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- 底部01--><ins style="display:block" data-ad-client="ca-pub-7674654031652018" data-ad-slot="3127803056" data-ad-format="auto" class="adsbygoogle"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});

</script><div id="SOHUCS"></div><script charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/changyan.js"></script><script type="text/javascript">window.changyan.api.config({
appid: 'cytkri3BC',
conf: 'prod_1e787a373da7a5fa9ef7156a6dae5e6b'
});
</script></main><footer class="footer-container"><div class="paginator"><a href="/2017/12/12/swift-tour/" class="prev">上一篇</a><a href="/2017/12/11/过秦论/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 <a href="mailto:fupeng_2005@126.com">kunpengku</a>, <a href="http://www.miitbeian.gov.cn">京ICP备17058936号-1</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"angrypowman",'auto');ga('send','pageview');</script></body></html>